name: Pull request maven
on:
  workflow_call:
    inputs:
      runs-on:
        required: false
        type: string
        description: 'Which runner image to run the workflow.'
        default: 'ubuntu-latest'
      java-version:
        required: false
        type: string
        description: 'Which Java SDK version to build app.'
        default: '21'
      with-coverage:
        required: false
        type: boolean
        description: 'If true: sets the maven profile "coverage" and uploads the coverage report'
        default: false
      profile:
        required: false
        type: string
        description: 'Which maven profile to use for tests.'
        default: ''
      coverage-artifact-name:
        required: false
        type: string
        default: ${{ inputs.with-coverage && inputs.profile || ''}}
      coverage-artifact-path:
        required: false
        type: string
        default: ${{ inputs.with-coverage && format('coverage/{0}', inputs.profile) || '' }}
jobs:
  pull-request-maven:
    name: Pull request maven
    permissions:
      contents: read # fetch repo
    runs-on: ${{ inputs.runs-on }}
    env:
      TZ: 'Europe/Oslo'
    outputs:
      image: ${{ steps.build-push-docker-image.outputs.image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # ratchet:actions/checkout@v4
      - name: Setup java and maven
        uses: navikt/familie-baks-gha-workflows/.github/actions/setup-java-maven@main # ratchet:exclude
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          java-version: ${{ inputs.java-version }}
      - name: Maven verify
        uses: navikt/familie-baks-gha-workflows/.github/actions/build-maven@main # ratchet:exclude
        env:
          TESTCONTAINERS_REUSE_ENABLE: true
        with:
          maven-command: 'verify'
          skip-tests: ${{ inputs.skip-tests }}
          profile: ${{ inputs.profile }}
          with-coverage: ${{ inputs.with-coverage }}
      - name: Upload code coverage report
        if: ${{ inputs.with-coverage }}
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # ratchet:actions/upload-artifact@v4
        with:
          name: ${{ inputs.coverage-artifact-name }}
          path: ${{ inputs.coverage-artifact-path }}
          retention-days: 1
          overwrite: true
