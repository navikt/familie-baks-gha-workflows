name: Pull request maven
on:
  workflow_call:
    inputs:
      runs-on:
        required: false
        type: string
        description: 'Which runner image to run the workflow.'
        default: 'ubuntu-latest'
      java-version:
        required: false
        type: string
        description: 'Which Java SDK version to build app.'
        default: '21'
      with-coverage:
        required: false
        type: boolean
        description: 'If true: sets the maven profile "coverage" and uploads the coverage report'
        default: false
      profile:
        required: false
        type: string
        description: 'Which maven profile to use for tests.'
        default: ''
      coverage-artifact-name:
        required: false
        type: string
        default: ${{ inputs.with-coverage && inputs.profile || ''}}
      coverage-artifact-path:
        required: false
        type: string
        default: ${{ inputs.with-coverage && format('coverage/{0}', inputs.profile) || '' }}
jobs:
  pull-request-maven:
    name: Pull request maven${{ inputs.profile && format(' - {0}', inputs.profile) || '' }}
    permissions:
      contents: read
    runs-on: ${{ inputs.runs-on }}
    env:
      TZ: 'Europe/Oslo'
    outputs:
      image: ${{ steps.build-push-docker-image.outputs.image }}
    steps:
      - name: Checkout code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # ratchet:actions/checkout@v4
      - name: Setup java and maven
        uses: navikt/familie-baks-gha-workflows/.github/actions/setup-java-maven@main # ratchet:exclude
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          java-version: ${{ inputs.java-version }}
      - name: Run test with profile ${{ inputs.profile }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          mvn verify \
            --settings maven-settings.xml \
            --errors \
            --batch-mode \
            --no-transfer-progress \
            --quiet \
            -Dsurefire.rerunFailingTestsCount=2 \
            -Dmaven.artifact.threads=10 \
            ${{ inputs.profile && format('-P{0}', inputs.profile) || '' }} \
            ${{ inputs.with-coverage && '-Pcoverage' || '' }} \
            ${{ inputs.maven-custom-args }}
      - name: Upload code coverage report
        if: ${{ inputs.with-coverage }}
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # ratchet:actions/upload-artifact@v4
        with:
          name: ${{ inputs.coverage-artifact-name }}
          path: ${{ inputs.coverage-artifact-path }}
          retention-days: 1
          overwrite: true
