name: Sonar
on:
  workflow_call:
    inputs:
      runs-on:
        required: false
        type: string
        description: 'Which runner image to run the workflow.'
        default: 'ubuntu-latest'
      java-version:
        required: false
        type: string
        description: 'Which Java SDK version to build app.'
        default: '21'
      coverage-flag:
        required: false
        type: string
        default: '-Dsonar.coverage.jacoco.xmlReportPaths'
      unit-test-artifact-name:
        required: false
        type: string
        default: 'enhetstest'
      unit-test-artifact-path:
        required: false
        type: string
        default: 'coverage/enhetstest'
      integration-test-artifact-name:
        required: false
        type: string
        default: 'integrasjonstest'
      integration-test-artifact-path:
        required: false
        type: string
        default: 'coverage/integrasjonstest'
    secrets:
      SONAR_TOKEN:
        required: true
jobs:
  sonar:
    if: github.actor != 'dependabot[bot]' && github.event_name != 'merge_group'
    name: Sonar
    runs-on: ${{ inputs.runs-on }}
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # ratchet:actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup java and maven
        uses: navikt/familie-baks-gha-workflows/.github/actions/setup-java-maven@main # ratchet:exclude
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          java-version: ${{ inputs.java-version }}
      - name: Download unit test report artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # ratchet:actions/download-artifact@v4
        with:
          name: ${{ inputs.unit-test-artifact-name }}
          path: ${{ inputs.unit-test-artifact-path }}
      - name: Download integration test report artifact
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # ratchet:actions/download-artifact@v4
        with:
          name: ${{ inputs.integration-test-artifact-name }}
          path: ${{ inputs.integration-test-artifact-path }}
      - name: Cache Sonar packages
        uses: actions/cache@0057852bfaa89a56745cba8c7296529d2fc39830 # ratchet:actions/cache@v4
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar
      - name: Sonar
        env:
          MAVEN_OPTS: "-Xmx4g -Dmaven.artifact.threads=10"
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          mvn sonar:sonar ${{ inputs.coverage-flag }}="${{ inputs.unit-test-artifact-path }}/${{ inputs.unit-test-artifact-name }}.xml,${{ inputs.integration-test-artifact-path }}/${{ inputs.integration-test-artifact-name }}.xml"
